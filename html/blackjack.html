<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>James Ockenfels – Blackjack</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f7f7f7;
      --text:#333;
      --brand:#66fcf1;
      --brand-2:#45a29e;
      --header:#1f2833;
      --card:#ffffff;
      --muted:#c5c6c7;
      --shadow:0 8px 30px rgba(0,0,0,.15);
      --soft:0 4px 12px rgba(0,0,0,.12);
      --win:#2e7d32; --lose:#c62828; --push:#6d4c41;
    }
    *{box-sizing:border-box}
    html,body{height:100%;font-family:Roboto,system-ui,-apple-system,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0}
    header{background:var(--header);color:var(--brand);padding:20px 40px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 10px rgba(0,0,0,.1)}
    header h1{margin:0;font-size:1.8rem;font-weight:700}
    header nav a{color:var(--brand);margin-left:20px;text-decoration:none;font-size:1.05rem;transition:.2s}
    header nav a:hover{color:var(--brand-2)}

    main{max-width:1200px;margin:24px auto;padding:16px;width:100%}
    
    /* New grid layout */
    .game-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto auto;
      gap: 20px;
    }
    
    .grid-card-area {
      grid-column: 1;
      grid-row: 1;
    }
    
    .grid-controls {
      grid-column: 2;
      grid-row: 1;
    }
    
    .grid-log {
      grid-column: 1;
      grid-row: 2;
    }
    
    .grid-save {
      grid-column: 2;
      grid-row: 2;
    }

    .table{
      background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:18px
    }

    .panel{background:#fff;border-radius:12px;box-shadow:var(--soft);padding:16px;margin-bottom:16px}
    .panel h3{margin:0 0 8px;font-size:1.1rem;color:#1f2833}

    .bank{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:12px}
    .bank .pill{background:#f0f0f0;padding:10px 12px;border-radius:999px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    .bank input[type="number"]{padding:10px;border-radius:8px;border:1px solid #ddd;width:140px}

    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    button{
      appearance:none;border:0;border-radius:10px;background:var(--header);color:var(--brand);padding:10px 14px;font-weight:600;cursor:pointer;box-shadow:0 4px 14px rgba(0,0,0,.12);transition:transform .05s ease,opacity .2s
    }
    button:hover{opacity:.95}
    button:active{transform:scale(.98)}
    button[disabled]{opacity:.45;cursor:not-allowed}
    .btn-ghost{background:#eef7f7;color:#0f2027}
    .btn-danger{background:#b71c1c;color:#fff}

    .settings{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
    .settings label{display:flex;flex-direction:column;gap:6px;font-size:.95rem}
    .settings input,.settings select{padding:10px;border:1px solid #ddd;border-radius:8px;background:#fff}

    .felt{background:radial-gradient(circle at 30% 20%, #2a7b6f 0%, #0f3b35 60%, #0a2a26 100%);border-radius:16px;padding:16px;min-height:280px;color:#e8fffb;position:relative;overflow:hidden}
    .felt h2{margin:0 0 8px;font-weight:700}
    .hand{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;min-height:120px}
    .row-hands{display:grid;grid-template-columns:1fr;gap:16px}

    /* Playing card styles - fixed */
    .card{width:70px;height:98px;border-radius:10px;background:#fff;border:1px solid #ddd;box-shadow:0 6px 14px rgba(0,0,0,.2);position:relative;padding:6px;display:flex;flex-direction:column;justify-content:space-between}
    .card .corner{font-weight:800;font-size:14px}
    .card .center{display:flex;justify-content:center;align-items:center;font-size:1.6rem;flex-grow:1}
    .card .corner:last-child{text-align:right}
    .card.red{color:#c62828}
    .card.back{background:repeating-linear-gradient(45deg,#133, #133 6px, #1f2833 6px, #1f2833 12px);border-color:#0d2228}

    .score{background:rgba(0,0,0,.35);padding:6px 10px;border-radius:999px;font-weight:700;display:inline-flex;gap:6px;align-items:center;margin-bottom:8px}

    .status{margin-top:10px;font-weight:700}
    .status.win{color:var(--win)}
    .status.lose{color:var(--lose)}
    .status.push{color:var(--push)}

    .log{max-height:220px;overflow:auto;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#0f2027;color:#e0ffff;border-radius:12px;padding:12px}
    .log b{color:var(--brand)}

    .io{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    input[type="file"]{display:none}
    .file-label{border:1px dashed #89d7d2;color:#0f2027;background:#e8fffb;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;box-shadow:0 4px 14px rgba(0,0,0,.12)}
    .link{
      color:var(--brand-2);text-decoration:none
    }
    .help{font-size:.9rem;color:#555;margin-top:8px}

    footer{margin:24px 0 12px;text-align:center;color:#6b7280}

    /* Footer */
    footer {
        background-color: #1f2833;
        color: #c5c6c7;
        text-align: center;
        padding: 15px;
        margin-top: 30px;
    }

    footer a {
        color: #66fcf1;
        margin: 0 10px;
        text-decoration: none;
        transition: color 0.3s ease;
    }

    footer a:hover {
        color: #45a29e;
    }
  </style>
</head>
<body>
<header>
  <div class="left-header"><h1>James Ockenfels</h1></div>
  <nav class="right-header">
    <a href="../index.html">Home</a>
    <a href="projects.html">Projects</a>
    <a href="goals.html">Goals</a>
    <a href="education.html">Education</a>
    <a href="about.html">About Me</a>
    <a href="contact.html">Contact</a>
    <a href="info.html">Info</a>
    <a href="blackjack.html">BlackJack (NEW!)</a>
  </nav>
</header>

<main>
  <div class="table">
    <div class="game-grid">
      <!-- Top Left: Cards -->
      <div class="grid-card-area">
        <div class="panel felt">
          <h2>Blackjack</h2>
          <div class="row-hands">
            <div>
              <div class="score">Dealer: <span id="dealer-score">0</span></div>
              <div id="dealer-hand" class="hand" aria-live="polite"></div>
            </div>
            <div>
              <div class="score">Player: <span id="player-score">0</span></div>
              <div id="player-hand" class="hand" aria-live="polite"></div>
              <div id="round-status" class="status"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Top Right: Bank & Controls -->
      <div class="grid-controls">
        <div class="panel">
          <h3>Bank & Bet</h3>
          <div class="bank">
            <div class="pill">Bank: $<span id="bank">1000</span></div>
            <label>
              Bet amount
              <input id="bet" type="number" min="1" step="1" value="25" />
            </label>
          </div>
          <div class="controls">
            <button id="deal-btn">Deal</button>
            <button id="hit-btn" disabled>Hit</button>
            <button id="stand-btn" disabled>Stand</button>
            <button id="double-btn" disabled>Double</button>
            <button id="newshoe-btn" class="btn-ghost">New Shoe</button>
          </div>
          <div class="help">Blackjack pays 3:2. Dealer <span id="dealer-rule"></span>.</div>
        </div>

        <div class="panel">
          <h3>Settings</h3>
          <div class="settings">
            <label> Decks in shoe
              <select id="decks">
                <option>1</option>
                <option>2</option>
                <option selected>4</option>
                <option>6</option>
                <option>8</option>
              </select>
            </label>
            <label> Dealer hits soft 17
              <select id="hit-soft-17">
                <option value="false" selected>No (stands on all 17)</option>
                <option value="true">Yes (hits soft 17)</option>
              </select>
            </label>
            <label> Auto-reshuffle at % remaining
              <input id="penetration" type="number" min="5" max="90" step="5" value="25" />
            </label>
          </div>
        </div>
      </div>

      <!-- Bottom Left: Round Log -->
      <div class="grid-log">
        <div class="panel">
          <h3>Round Log</h3>
          <div id="log" class="log" aria-live="polite"></div>
        </div>
      </div>

      <!-- Bottom Right: Save Data -->
      <div class="grid-save">
        <div class="panel">
          <h3>Save / Load</h3>
          <div class="io">
            <button id="export-btn">Export Save</button>
            <label for="import-file" class="file-label">Import Save</label>
            <input id="import-file" type="file" accept="application/json" />
            <button id="reset-btn" class="btn-danger">Reset</button>
          </div>
          <p class="help">Save includes bank, settings, and shoe state. You can move it between browsers by exporting a JSON file, then importing it here.</p>
        </div>
      </div>
    </div>
    <footer>Have fun & play responsibly.</footer>
  </div>
</main>

<script>
(function(){
  // --- Utilities ---
  const $ = (sel) => document.querySelector(sel);
  const logEl = $('#log');
  const stateVersion = 1;

  function log(msg){
    const line = document.createElement('div');
    line.innerHTML = msg; 
    logEl.prepend(line);
    // Auto-scroll to top
    logEl.scrollTop = 0;
  }

  // Card helpers
  const suits = ['♠','♥','♦','♣'];
  const ranks = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
  
  function buildDeck(decks=1){
    const d=[];
    for(let k=0;k<decks;k++){
      for(const s of suits){
        for(const r of ranks){
          const value = r==='A'?11:(['J','Q','K'].includes(r)?10:Number(r));
          d.push({r,s,value});
        }
      }
    }
    return shuffle(d);
  }
  
  function shuffle(a){
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  function handValue(hand){
    let total = 0; let aces = 0;
    for(const c of hand){ total += c.value; if(c.r==='A') aces++; }
    while(total>21 && aces>0){ total -= 10; aces--; }
    return total;
  }
  
  function isBlackjack(hand){ return hand.length===2 && handValue(hand)===21; }
  
  function isSoft(hand){
    // Soft if there is an Ace counted as 11 (i.e., total <= 21 and at least one Ace that hasn't been converted)
    let total = 0; let aces = 0;
    for(const c of hand){ total += c.value; if(c.r==='A') aces++; }
    while(total>21 && aces>0){ total -= 10; aces--; }
    return aces>0 && total<=21; // any remaining Ace counted as 11
  }

  // Fixed card rendering function
  function cardEl(c){
    const el = document.createElement('div'); 
    el.className = 'card' + ((c.s==='♥'||c.s==='♦')?' red':'');
    
    const top = document.createElement('div'); 
    top.className='corner'; 
    top.textContent = c.r;
    
    const center = document.createElement('div'); 
    center.className='center'; 
    center.textContent = c.s;
    
    const bot = document.createElement('div'); 
    bot.className='corner'; 
    bot.style.textAlign='right'; 
    bot.textContent = c.r;
    
    el.appendChild(top); 
    el.appendChild(center); 
    el.appendChild(bot);
    
    return el;
  }
  
  function backEl(){ 
    const el = document.createElement('div'); 
    el.className='card back'; 
    return el; 
  }

  // --- Game State ---
  const storageKey = 'bj-save';
  const defaults = {
    bank: 1000,
    bet: 25,
    decks: 4,
    hitSoft17: false,
    penetration: 25,
    shoe: [],
    discard: [],
  };
  let G = loadState();

  const dealerScoreEl = $('#dealer-score');
  const playerScoreEl = $('#player-score');
  const dealerHandEl = $('#dealer-hand');
  const playerHandEl = $('#player-hand');
  const statusEl = $('#round-status');

  const bankEl = $('#bank');
  const betEl = $('#bet');
  const decksSel = $('#decks');
  const hitSoftSel = $('#hit-soft-17');
  const penEl = $('#penetration');
  const dealerRuleEl = $('#dealer-rule');

  const dealBtn = $('#deal-btn');
  const hitBtn = $('#hit-btn');
  const standBtn = $('#stand-btn');
  const doubleBtn = $('#double-btn');
  const newShoeBtn = $('#newshoe-btn');
  const exportBtn = $('#export-btn');
  const importFile = $('#import-file');
  const resetBtn = $('#reset-btn');

  let round = null; // will hold hands and bet during a round

  initUI();
  ensureShoe();
  renderShoeRule();
  saveState();

  // --- Event wiring ---
  dealBtn.addEventListener('click', onDeal);
  hitBtn.addEventListener('click', () => onHit());
  standBtn.addEventListener('click', () => dealerTurn());
  doubleBtn.addEventListener('click', onDouble);
  newShoeBtn.addEventListener('click', () => { newShoe(); render(); saveState(); });
  exportBtn.addEventListener('click', onExport);
  importFile.addEventListener('change', onImport);
  resetBtn.addEventListener('click', () => { if(confirm('Reset bank and settings?')){ G = structuredClone(defaults); newShoe(); render(); saveState(); log('<b>Reset</b> all data.'); }});

  decksSel.addEventListener('change', () => { G.decks = parseInt(decksSel.value,10); newShoe(); saveState(); renderShoeRule(); });
  hitSoftSel.addEventListener('change', () => { G.hitSoft17 = hitSoftSel.value==='true'; saveState(); renderShoeRule(); });
  penEl.addEventListener('change', () => { G.penetration = clamp(parseInt(penEl.value,10)||25,5,90); penEl.value=G.penetration; saveState(); });
  betEl.addEventListener('change', () => { G.bet = Math.max(1, Math.floor(Number(betEl.value)||25)); betEl.value = G.bet; saveState(); });

  function clamp(n,min,max){ return Math.min(Math.max(n,min),max); }

  function initUI(){
    bankEl.textContent = G.bank;
    betEl.value = G.bet;
    decksSel.value = String(G.decks);
    hitSoftSel.value = String(G.hitSoft17);
    penEl.value = G.penetration;
    render();
  }

  function render(){
    dealerHandEl.innerHTML=''; playerHandEl.innerHTML=''; statusEl.textContent=''; statusEl.className='status';
    dealerScoreEl.textContent='0'; playerScoreEl.textContent='0';
    if(round){
      // Render dealer (hide hole if in progress)
      const hideHole = !round.done;
      round.dealer.forEach((c,i)=>{
        dealerHandEl.appendChild((i===1 && hideHole)?backEl():cardEl(c));
      });
      const pScore = handValue(round.player);
      playerScoreEl.textContent = pScore;
      dealerScoreEl.textContent = hideHole ? (round.dealer[0] ? (round.dealer[0].r==='A'?11:(['J','Q','K'].includes(round.dealer[0].r)?10:Number(round.dealer[0].r))) : 0) : handValue(round.dealer);
      round.player.forEach(c=>playerHandEl.appendChild(cardEl(c)));
      if(round.message){ statusEl.textContent = round.message.text; statusEl.classList.add(round.message.kind); }
    }
    bankEl.textContent = G.bank;
    updateButtons();
  }

  function updateButtons(){
    const inRound = !!round && !round.done;
    dealBtn.disabled = inRound;
    hitBtn.disabled = !inRound;
    standBtn.disabled = !inRound;
    doubleBtn.disabled = !inRound || round.player.length!==2 || G.bank < round.bet; // double only on 2 cards
  }

  function ensureShoe(){
    if(!G.shoe || G.shoe.length===0){ newShoe(); }
  }
  
  function newShoe(){
    G.shoe = buildDeck(G.decks);
    G.discard = [];
    log(`<b>New shoe</b> with ${G.decks} deck(s).`);
  }

  function draw(){
    if(G.shoe.length===0){ newShoe(); }
    // auto-reshuffle based on penetration remaining
    const remainingPct = Math.round((G.shoe.length / (52*G.decks)) * 100);
    if(remainingPct <= G.penetration){
      // combine discard and shoe and reshuffle to simulate shuffle at cut card
      G.shoe = shuffle([...G.shoe, ...G.discard]);
      G.discard = [];
      log(`<b>Shuffle</b> at cut card (${remainingPct}% remaining).`);
    }
    const c = G.shoe.pop();
    return c;
  }

  function onDeal(){
    const bet = Math.max(1, Math.floor(Number(betEl.value)||G.bet));
    if(bet>G.bank){ alert('Bet exceeds bank.'); return; }
    G.bet = bet; saveState();

    round = { bet, player:[], dealer:[], done:false, message:null };
    round.player.push(draw());
    round.dealer.push(draw());
    round.player.push(draw());
    round.dealer.push(draw());

    // natural blackjack check
    const pBJ = isBlackjack(round.player);
    const dBJ = isBlackjack(round.dealer);

    if(pBJ || dBJ){
      settle(true);
      return;
    }

    render();
  }

  function onHit(){
    if(!round || round.done) return;
    round.player.push(draw());
    const v = handValue(round.player);
    if(v>21){
      settle(false, 'Player busts.');
      return;
    }
    render();
  }

  function onDouble(){
    if(!round || round.done) return;
    if(G.bank < round.bet){ return; }
    G.bank -= round.bet; // stake additional bet immediately
    round.bet *= 2;
    round.player.push(draw());
    const v = handValue(round.player);
    if(v>21){ settle(false, 'Player busts after double.'); return; }
    dealerTurn(true);
  }

  function dealerTurn(fromDouble=false){
    if(!round || round.done) return;
    // Reveal hole and hit per rules
    while(true){
      const v = handValue(round.dealer);
      const soft = isSoft(round.dealer);
      if(v<17) { round.dealer.push(draw()); continue; }
      if(v===17 && soft && G.hitSoft17){ round.dealer.push(draw()); continue; }
      break;
    }
    settle(false);
  }

  function settle(immediateNatural=false, overrideMsg=null){
    // Deduct initial stake on first settle if not already deducted
    if(!round.paid){ G.bank -= round.bet; round.paid=true; }

    const p = handValue(round.player);
    const d = handValue(round.dealer);

    let result, payout=0, msg='';
    const pBJ = isBlackjack(round.player);
    const dBJ = isBlackjack(round.dealer);

    if(immediateNatural){
      if(pBJ && dBJ){ result='push'; payout = round.bet; msg='Both blackjack – push.'; }
      else if(pBJ){ result='win'; payout = round.bet + Math.floor(round.bet*1.5); msg='Blackjack! Paid 3:2.'; }
      else if(dBJ){ result='lose'; payout = 0; msg='Dealer blackjack.'; }
    } else if(overrideMsg){
      if(p>21){ result='lose'; payout=0; msg=overrideMsg; }
    } else {
      if(p>21){ result='lose'; payout=0; msg='Player busts.'; }
      else if(d>21){ result='win'; payout=round.bet*2; msg='Dealer busts.'; }
      else if(p>d){ result='win'; payout=round.bet*2; msg='Player wins.'; }
      else if(p<d){ result='lose'; payout=0; msg='Dealer wins.'; }
      else { result='push'; payout=round.bet; msg='Push.'; }
    }

    G.bank += payout;

    round.done = true;
    round.message = { text: msg+` (P: ${p} vs D: ${d})`, kind: result };

    // move cards to discard
    G.discard.push(...round.player, ...round.dealer);

    render(); saveState();

    const sym = result==='win'?'✅':result==='lose'?'❌':'➖';
    log(`${sym} Bet $${round.bet}. ${round.message.text} Bank: $${G.bank}.`);
  }

  function saveState(){
    const save = {
      v: stateVersion,
      when: new Date().toISOString(),
      data: {
        bank: G.bank,
        bet: G.bet,
        decks: G.decks,
        hitSoft17: G.hitSoft17,
        penetration: G.penetration,
        shoe: G.shoe,
        discard: G.discard
      }
    };
    localStorage.setItem(storageKey, JSON.stringify(save));
  }
  
  function loadState(){
    try{
      const raw = localStorage.getItem(storageKey);
      if(!raw) return structuredClone(defaults);
      const parsed = JSON.parse(raw);
      return { ...structuredClone(defaults), ...parsed.data };
    }catch(e){
      console.warn('Failed to load save', e);
      return structuredClone(defaults);
    }
  }

  function onExport(){
    const payload = localStorage.getItem(storageKey) || JSON.stringify({v:stateVersion,when:new Date().toISOString(),data:defaults});
    const blob = new Blob([payload], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'blackjack-save.json';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  async function onImport(ev){
    const file = ev.target.files[0]; if(!file) return;
    try{
      const text = await file.text();
      const obj = JSON.parse(text);
      if(!obj || !obj.data) throw new Error('Invalid save');
      // merge with defaults to be safe
      G = { ...structuredClone(defaults), ...obj.data };
      render(); saveState(); log('<b>Imported</b> save file.');
    }catch(e){
      alert('Could not import save: '+e.message);
    } finally {
      ev.target.value='';
    }
  }

  function renderShoeRule(){
    dealerRuleEl.textContent = G.hitSoft17 ? 'hits soft 17' : 'stands on all 17';
  }

})();
</script>
    <footer>
        <p>Connect with me:</p>
        <a href="https://github.com">GitHub</a>
        <a href="https://youtube.com">YouTube</a>
        <a href="https://tryhackme.com">TryHackMe</a>
    </footer>
</body>
</html>